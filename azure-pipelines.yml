trigger:
- master

pool:
  vmImage: 'windows-2019'

steps:
- task: UseDotNet@2
  displayName: 'Use dotnet sdk 3.x'
  inputs:
    version: '3.x'
    includePreviewVersions: false

- task: DotNetCoreCLI@2
  displayName: 'dotnet restore'
  inputs:
    command: restore
    projects: FileOptics.sln

# - task: DotNetCoreCLI@2
#   displayName: 'dotnet test'
#   inputs:
#     command: test
#     projects: '**/*.Test.csproj'

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: build
    configuration: release

- task: DotNetCoreCLI@2
  displayName: 'dotnet pack'
  inputs:
    command: pack
    projects: 'FileOptics/FileOptics.csproj'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Build Artifacts'
  inputs:
    ArtifactName: FileOptics

- task: NuGetToolInstaller@1
  inputs:
    versionSpec: '5.1.0'

- task: NuGetCommand@2
  displayName: 'Deploy To Nuget.org'
  condition: |
    and(
        ne(variables['Build.Reason'], 'PullRequest'),
        not(contains(variables['Build.SourceVersionMessage'], 'skip-deploy')),
        or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['deploy'], 'true'))
    )
  inputs:
    command: push
    nugetFeedType: 'external'
    publishVstsFeed: nuget.org
    externalEndPoint: 'kylewrader-nuget'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
